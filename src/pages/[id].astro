---
import Layout from "../layouts/Layout.astro";
import ytdl from "ytdl-core";

const { id } = Astro.params;
const video = await ytdl.getInfo(id || "");
---

<Layout title={video.videoDetails.title}>
  <video controls class="w-full p-3" width="1250" height="730">
    <source
      src={video.formats
        .filter((i) => i.audioBitrate != null && i.qualityLabel != null)
        .slice(-1)[0].url}
      type="video/mp4"
    />
    Your browser does not support the video tag.
  </video>
  <div class="md:flex lg:flex">
    <div class="md:w-3/4 lg:w-3/4 p-3">
      <div class="p-4 rounded-md shadow-lg bg-hover">
        <h1 class="font-bold text-lg mb-3">{video.videoDetails.title}</h1>
        <div class="flex">
          <img
            class="rounded-full mr-3"
            src={video.videoDetails.author.thumbnails[0].url}
          />
          <div>
            <a href={video.videoDetails.author.channel_url}>
              {video.videoDetails.author.name}
              <span class="text-gray-500">{video.videoDetails.author.user}</span
              >
            </a>
            <br />
            <span class="text-gray-500">
              {
                video.videoDetails.author.subscriber_count?.toLocaleString(
                  undefined,
                  { minimumFractionDigits: 2 }
                )
              } subscribers
            </span>

            <span class="text-gray-500">
              {video.videoDetails.viewCount} views
            </span>
          </div>
        </div>
      </div>

      <div class="whitespace-pre-line p-4 rounded-md shadow-lg bg-hover mt-4">
        {video.videoDetails.description}
      </div>
    </div>

    <div class="pl-3 pr-3 md:w-1/4 lg:w-1/4 mt-3">
      {
        video.related_videos.map((i) => {
          return (
            <div class="md:w-72 lg:w-72 p-4 rounded-md shadow-lg bg-hover justify-end mb-3">
              <div>
                <a href={`/${i.id}`}>
                  <img
                    class="rounded-lg mb-2"
                    src={i.thumbnails.slice(-1)[0].url}
                  />
                </a>
                <a class="break-words" href={`/${i.id}`}>
                  {i.title}
                </a>
                <br />
                <span class="text-gray-500">{i.author?.name || "???"}</span>
                <span class="text-gray-500">
                  {i.short_view_count_text} views
                </span>
                <span class="text-gray-500">{i.published}</span>
              </div>
            </div>
          );
        })
      }
    </div>
  </div>
</Layout>
